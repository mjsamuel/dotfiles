#!/bin/sh
DEFAULTS="/usr/bin/defaults"
OSASCIPT="/usr/bin/osascript"

changeSystemColors() {
	darkMode="$([ "$1" = "dark" ] && echo "true" || echo "false")"
	$OSASCIPT -l JavaScript -e "Application('System Events').appearancePreferences.darkMode = $darkMode" 1>/dev/null
	changeNvimColors "$1"
}

changeNvimColors() {
	tmux list-panes -a -F '#{pane_current_command} #{pane_id}' | while read -r p; do
		target="${p%% *}"
		id="${p##* }"
		if [ "$target" = "nvim" ]; then
			tmux send-keys -t "$id" Escape ":set background=$1" C-m
		fi
	done
}

if [ "$1" = "dark" ] || [ "$1" = "light" ]; then
	changeSystemColors "$1"
else
    # If no argument is given, toggle the current mode
	color=$(if $DEFAULTS read -g AppleInterfaceStyle >/dev/null 2>&1; then echo "light"; else echo "dark"; fi)
	changeSystemColors "$color"
fi
