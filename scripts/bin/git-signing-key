#!/bin/sh

set -u # Exit on undefined variables

ALLOWED_SIGNERS="${HOME}/.ssh/allowed_signers"
DEFAULT_KEY="ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHwY8TMNibwrhKckE/dzJIaSzflrBN0K/tNRpzHkeev3"

# Cleanup function
cleanup() {
	[ -n "${tmp_loaded:-}" ] && rm -f "$tmp_loaded"
	[ -n "${tmp_allowed:-}" ] && rm -f "$tmp_allowed"
}

trap cleanup EXIT INT TERM

# If not in SSH session, delegate to 1Password
if [ -z "${SSH_CONNECTION:-}" ]; then
	echo "$DEFAULT_KEY"
	exit 0
fi

# Create temporary files with restricted permissions
tmp_loaded=$(mktemp) || exit 1
tmp_allowed=$(mktemp) || exit 1
chmod 600 "$tmp_loaded" "$tmp_allowed"

# Extract and sort keys from SSH agent
if ! ssh-add -L 2>/dev/null | awk '{print $1" "$2}' | sort >"$tmp_loaded"; then
	echo "Error: Failed to list SSH keys from agent" >&2
	exit 1
fi

# Check if we have any loaded keys
if [ ! -s "$tmp_loaded" ]; then
	echo "Error: No SSH keys found in agent" >&2
	exit 1
fi

# Check if allowed_signers exists
if [ ! -f "$ALLOWED_SIGNERS" ]; then
	echo "Error: allowed_signers file not found at $ALLOWED_SIGNERS" >&2
	exit 1
fi

# Extract and sort allowed signers
if ! awk '{print $2" "$3}' "$ALLOWED_SIGNERS" 2>/dev/null | sort >"$tmp_allowed"; then
	echo "Error: Failed to parse allowed_signers file" >&2
	exit 1
fi

# Find common keys
common_key=$(comm -12 "$tmp_loaded" "$tmp_allowed" | head -n 1)

if [ -z "$common_key" ]; then
	echo "Error: No common SSH key found between agent and allowed_signers" >&2
	exit 1
fi

# Extract key components
key_type=$(echo "$common_key" | awk '{print $1}')
key_data=$(echo "$common_key" | awk '{print $2}')

# Find and output the full public key
full_key=$(ssh-add -L 2>/dev/null | grep -F "$key_type $key_data" | head -n 1)

if [ -z "$full_key" ]; then
	echo "Error: Failed to retrieve full key from agent" >&2
	exit 1
fi

# Output the key to stdout (this is what Git expects)
echo "$full_key"
