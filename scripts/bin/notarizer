#!/bin/sh
notes_dir="$HOME/Documents/notes"
os="$(uname -s)"
if [ "$os" = "Darwin" ]; then
	notes_dir="$HOME/Library/Mobile Documents/com~apple~CloudDocs/Notes"
fi
if [ ! -d "$notes_dir" ]; then
	mkdir -p "$notes_dir"
	git init
fi

FZF_DEFAULT_COMMAND="find '$notes_dir' -name '*.md' -print0 | xargs -0 ls -t | sed 's#${notes_dir}/##'"
# fzf output is in the format:
# ```
# query
# /path/to/selcted_file.md
# ```
result="$(
	fzf --preview "bat '${notes_dir}/{}' --color always --style plain" \
		--preview-window=right:50% --height=100% \
		--print-query \
		--bind "ctrl-n:print-query+abort" \
		--bind "ctrl-d:execute(rm -i '${notes_dir}/{}')+reload(${FZF_DEFAULT_COMMAND})"
)"

exit_code="$?"
if [ "$exit_code" -eq 130 ]; then
	exit 0
fi

note_path="$(echo "$result" | sed -n '2p')"
if [ -n "$note_path" ]; then
	nvim +"cd $notes_dir" "${notes_dir}/${note_path}"
	commit_message="Update note: $(basename "${note_path}".md)"
else
	query=$(echo "$result" | head -n1)
	if [ -n "$query" ]; then
		filename="$(echo "$query" | sed 's/^[[:space:]]*//; s/ /-/g')" # Trim leading spaces and replace spaces with hyphens
		title="$(echo "$query" | perl -pe 's/(\w+)/\u\L$1/g')"         # Capitalize each word
	else
		filename="$(date -I)"
		title="$(date '+%B %d, %Y')"
	fi
	nvim +"cd $notes_dir" -c "norm i # ${title}" -c "startinsert" "${notes_dir}/${filename}.md"
	commit_message="Add note: ${filename}"
fi

# Using git as a mechansim to backup and track changes to notes
backup() {
	git -C "$notes_dir" add -A >/dev/null 2>&1
	git -C "$notes_dir" commit -am "$commit_message" --no-gpg-sign >/dev/null 2>&1
}
backup &
