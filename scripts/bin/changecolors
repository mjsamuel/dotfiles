#!/bin/sh
set -e
set -u

# Configuration
readonly THEME_FILE_PATH="${OS_APPEARANCE_FILE:-${XDG_CACHE_HOME:-$HOME/.cache}/os_theme}"

# Change macOS system appearance
change_mac_colors() {
	local theme="$1"
	local dark_mode

	if [ "$theme" = "dark" ]; then
		dark_mode="true"
	else
		dark_mode="false"
	fi

	/usr/bin/osascript -l JavaScript -e \
		"Application('System Events').appearancePreferences.darkMode = $dark_mode" \
		>/dev/null 2>&1
}

# Update neovim color scheme in tmux panes
change_nvim_colors() {
	local theme="$1"

	if ! pgrep -q tmux; then
		return 0
	fi

	tmux list-panes -a -F '#{pane_current_command} #{pane_id}' 2>/dev/null |
		while IFS=' ' read -r command pane_id; do
			if [ "$command" = "nvim" ]; then
				tmux send-keys -t "$pane_id" Escape ":set background=$theme" C-m
			fi
		done
}

# Detect current macOS theme
get_mac_theme() {
	if /usr/bin/defaults read -g AppleInterfaceStyle >/dev/null 2>&1; then
        echo "light"
	else
		echo "dark"
	fi
}

# Read theme from file
get_theme_from_file() {
	if [ -f "$THEME_FILE_PATH" ] && grep -q "dark" "$THEME_FILE_PATH" 2>/dev/null; then
		echo "light"
	else
		echo "dark"
	fi
}

# Main logic
main() {
	local new_theme="$1"
	local os

	os="$(uname -s)"

	# Determine theme based on OS or arguments
	if [ "$os" = "Darwin" ]; then
		if [ -z "$new_theme" ]; then
			new_theme="$(get_mac_theme)"
		fi
		change_mac_colors "$new_theme" &
	elif [ -z "$new_theme" ]; then
		new_theme="$(get_theme_from_file)"
	fi

	# Update neovim instances
	change_nvim_colors "$new_theme" &

	# Persist theme to file
	mkdir -p "$(dirname "$THEME_FILE_PATH")"
	echo "$new_theme" >"$THEME_FILE_PATH"

	printf "Changed colors to %s\n" "$new_theme"
}

main "${1:-}"
