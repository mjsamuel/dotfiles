#!/bin/sh
THEME_FILE_PATH="${OS_APPEARANCE_FILE:-$XDG_CACHE_HOME/os_theme}"

changeMacColors() {
	darkMode="$([ "$1" = "dark" ] && echo "true" || echo "false")"
	/usr/bin/osascript -l JavaScript -e \
		"Application('System Events').appearancePreferences.darkMode = $darkMode" \
		>/dev/null 2>&1
}

changeNvimColors() {
	tmux_running=$(pgrep tmux)
	[ -z "$tmux_running" ] && return
	tmux list-panes -a -F '#{pane_current_command} #{pane_id}' | while read -r p; do
		target="${p%% *}"
		id="${p##* }"
		if [ "$target" = "nvim" ]; then
			tmux send-keys -t "$id" Escape ":set background=$1" C-m
		fi
	done
}

new_colors="$1"
os="$(uname -s)"
if [ "$os" = "Darwin" ]; then
	os_switcher="changeMacColors"
	new_colors="$(/usr/bin/defaults read -g AppleInterfaceStyle >/dev/null 2>&1 && echo "light" || echo "dark")"
fi

# Could not determine theme from OS, so read from file
if [ -z "$new_colors" ]; then
	grep "dark" "$THEME_FILE_PATH" >/dev/null && new_colors="light" || new_colors="dark"
fi

[ -n "$os_switcher" ] && $os_switcher "$new_colors" &
changeNvimColors "$new_colors" &

# Update theme file so that other applications like nvim can read it
echo "$new_colors" > "$THEME_FILE_PATH"

printf "Changed colors to %s\n" "$new_colors"
